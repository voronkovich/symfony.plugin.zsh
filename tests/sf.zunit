#!/usr/bin/env zunit

@test 'sf: shows an error if console not found' {
    run sf

    assert $state equals 1
    assert $output contains 'Console not found: bin/console'
}

@test 'sf: uses Symfony CLI if it is installed' {
    cd "${FIXTURES_PATH}/app"

    run sf about

    assert $state equals 0
    assert $output same_as 'symfony: console about'
}

@test 'sf: allows to disable Symfony CLI via SF_SYMFONY_CLI=off' {
    cd "${FIXTURES_PATH}/app"

    export SF_SYMFONY_CLI=on
    run sf list --no-ansi

    assert $state equals 0
    assert $output contains 'symfony: console list --no-ansi'

    export SF_SYMFONY_CLI=off
    run sf list --no-ansi

    assert $state equals 0
    assert $output contains 'php: bin/console list --no-ansi'

}

@test 'sf: runs default console command if no arguments provided' {
    cd "${FIXTURES_PATH}/app"

    export SF_SYMFONY_CLI=off

    run sf

    assert $state equals 0
    assert $output same_as 'php: bin/console '
}

@test 'sf: runs specified console command' {
    cd "${FIXTURES_PATH}/app"

    export SF_SYMFONY_CLI=off

    run sf about

    assert $state equals 0
    assert $output same_as 'php: bin/console about'
}

@test 'sf: allows to set console binary via SF_CONSOLE env' {
    cd "${FIXTURES_PATH}/app-laravel"

    export SF_SYMFONY_CLI=off
    export SF_CONSOLE=artisan

    run sf about

    assert $state equals 0
    assert $output same_as 'php: artisan about'
}

@test 'sf: allows to set "runner" via SF_RUNNER env' {
    cd "${FIXTURES_PATH}/app"

    export SF_RUNNER='docker compose exec php'

    run sf debug:router

    assert $state equals 0
    assert $output same_as 'docker: compose exec php php bin/console debug:router'
}

@test 'sf: allows to set "runner" via .env.local file' {
    cd "${FIXTURES_PATH}/app-env-local"

    run sf debug:container

    assert $state equals 0
    assert $output same_as 'docker: compose exec php php bin/console debug:container'
}

@test 'sf: runs commands locally if could not detect runner' {
    cd "${FIXTURES_PATH}/app"

    export SF_SYMFONY_CLI=off
    export SF_DDEV=off

    run sf status

    assert $state equals 0
    assert $lines[1] same_as 'Runner: local'

    run sf about

    assert $state equals 0
    assert $output same_as 'php: bin/console about'
}

@test 'sf: detects DDEV automatically' {
    cd "${FIXTURES_PATH}/app-ddev"

    export SF_SYMFONY_CLI=off
    export SF_DDEV=on

    run sf debug:container --show-envs

    assert $state equals 0
    assert $output contains 'ddev: exec -- php bin/console debug:container --show-envs'
}

@test 'sf: Allows to disable DDEV autodetection via SF_DDEV=off' {
    cd "${FIXTURES_PATH}/app-ddev"

    export SF_SYMFONY_CLI=off
    export SF_DDEV=off

    run sf debug:container --show-envs

    assert $state equals 0
    assert $output contains 'php: bin/console debug:container --show-envs'
}

@test 'sf: detects Docker automatically' {
    cd "${FIXTURES_PATH}/app-docker"

    run sf debug:container --show-envs

    assert $state equals 0
    assert $output contains 'docker-compose: exec -- php php bin/console debug:container --show-envs'
}

@test 'sf: Allows to disable Docker autodetection via SF_DOCKER=off' {
    cd "${FIXTURES_PATH}/app-docker"

    export SF_SYMFONY_CLI=off
    export SF_DOCKER=off

    run sf debug:container --show-envs

    assert $state equals 0
    assert $output contains 'php: bin/console debug:container --show-envs'
}

@setup {
    path=("${PWD}/bin" "${PWD}/tests/_fixtures/stubs" $path)
    FIXTURES_PATH="${PWD}/tests/_fixtures"
    unset SF_RUNNER
    unset SF_SYMFONY_CLI
    unset SF_DDEV
    unset SF_CONSOLE
}
